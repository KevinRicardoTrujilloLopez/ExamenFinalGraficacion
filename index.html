<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Galaga - Nivel 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    canvas { display: block; margin: 0 auto; }
  </style>
</head>
<body>
<script>
let player;
let bullets = [];
let enemies = [];
let level = 1;
let score = 0;
let lives = 3;
let gameStarted = false;
let gameOver = false;

function setup() {
  createCanvas(600, 600);
  player = new Player();
}

function draw() {
  background(0);

  if (!gameStarted) {
    showStartScreen();
    return;
  }

  if (gameOver) {
    showGameOver();
    return;
  }

  player.update();
  player.show();

  for (let i = bullets.length - 1; i >= 0; i--) {
    bullets[i].update();
    bullets[i].show();
    if (bullets[i].offscreen()) {
      bullets.splice(i, 1);
    } else {
      for (let j = enemies.length - 1; j >= 0; j--) {
        if (bullets[i] && enemies[j].hits(bullets[i])) {
          score += enemies[j].points;
          enemies.splice(j, 1);
          bullets.splice(i, 1);
          break;
        }
      }
    }
  }

  for (let enemy of enemies) {
    enemy.update();
    enemy.show();

    if (enemy.hitsPlayer(player) || enemy.y > height) {
      lives--;
      enemies.splice(enemies.indexOf(enemy), 1);
      if (lives <= 0) gameOver = true;
    }
  }

  if (enemies.length === 0) {
    level++;
    if (level > 1) {
      gameOver = true;
    } else {
      startLevel(level);
    }
  }

  showUI();
}

function keyPressed() {
  if (keyCode === LEFT_ARROW) {
    player.setDir(-1);
  } else if (keyCode === RIGHT_ARROW) {
    player.setDir(1);
  } else if (key === ' ' && gameStarted && !gameOver) {
    bullets.push(new Bullet(player.x + player.w / 2, player.y));
  } else if (key === 'Enter' && !gameStarted) {
    gameStarted = true;
    startLevel(1);
  }
}

function keyReleased() {
  if (keyCode === LEFT_ARROW || keyCode === RIGHT_ARROW) {
    player.setDir(0);
  }
}

function showUI() {
  fill(255);
  textSize(16);
  text(`Vidas: ${lives}`, 10, 20);
  text(`Puntos: ${score}`, 10, 40);
  text(`Nivel: ${level}`, 10, 60);
}

function showStartScreen() {
  background(0);
  fill(255);
  textAlign(CENTER);
  textSize(24);
  text("Presiona ENTER para comenzar", width / 2, height / 2);
}

function showGameOver() {
  background(0);
  fill(255, 0, 0);
  textAlign(CENTER);
  textSize(28);
  text("GAME OVER", width / 2, height / 2);
  textSize(18);
  text("Recarga la p√°gina para reiniciar", width / 2, height / 2 + 40);
}

function startLevel(lvl) {
  enemies = [];
  for (let i = 0; i < 10; i++) {
    let x = 60 + i * 50;
    enemies.push(new Enemy(x, 50));
  }
}

// ------------------ Clases ------------------

class Player {
  constructor() {
    this.w = 40;
    this.h = 20;
    this.x = width / 2 - this.w / 2;
    this.y = height - 50;
    this.dir = 0;
    this.speed = 5;
  }

  update() {
    this.x += this.dir * this.speed;
    this.x = constrain(this.x, 0, width - this.w);
  }

  show() {
    fill(0, 255, 0);
    rect(this.x, this.y, this.w, this.h);
  }

  setDir(d) {
    this.dir = d;
  }
}

class Bullet {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.r = 5;
    this.speed = 7;
  }

  update() {
    this.y -= this.speed;
  }

  show() {
    fill(255);
    ellipse(this.x, this.y, this.r * 2);
  }

  offscreen() {
    return this.y < 0;
  }
}

class Enemy {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.r = 20;
    this.speed = 1;
    this.points = 1;
  }

  update() {
    this.y += this.speed;
  }

  show() {
    fill(255, 0, 0);
    ellipse(this.x, this.y, this.r * 2);
  }

  hits(bullet) {
    let d = dist(this.x, this.y, bullet.x, bullet.y);
    return d < this.r + bullet.r;
  }

  hitsPlayer(player) {
    return (
      this.x > player.x &&
      this.x < player.x + player.w &&
      this.y + this.r > player.y
    );
  }
}
</script>
</body>
</html>
